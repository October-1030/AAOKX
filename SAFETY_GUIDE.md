# 🛡️ 安全交易指南 - 方案A实施手册

> **最后更新**: 2025-01-10
> **状态**: 三合一智能止盈系统 + 安全熔断机制已实现

---

## 📋 目录

1. [系统概述](#系统概述)
2. [安全保护机制](#安全保护机制)
3. [方案A执行步骤](#方案a执行步骤)
4. [监控与调整](#监控与调整)
5. [常见问题](#常见问题)

---

## 系统概述

### 已实现的功能

✅ **三合一智能止盈系统**
- 第1层：分批止盈（主动获利）
- 第2层：高点回撤保护（利润保护）
- 第3层：移动止损（底线防御）

✅ **安全熔断机制**
- 总亏损熔断：-20% 自动停止
- 单日亏损限制：-5% 暂停当天
- 高风险交易审核：杠杆>15x 或单笔>$5000（可选）

✅ **风险管理**
- 每日交易次数限制：150次
- 2:1 最小盈亏比强制验证
- 动态杠杆选择（1x-20x）

---

## 安全保护机制

### 1️⃣ 总亏损熔断（Circuit Breaker）

```
触发条件：账户总回报 ≤ -20%
触发后果：🚨 立即停止所有交易，需要手动干预

示例：
初始资金: $10,000
当前权益: $8,000 或更低
→ 熔断触发！系统停止运行
```

**如何恢复**：
1. 检查日志，分析亏损原因
2. 调整策略参数（在 `lib/config.ts` 修改）
3. 重启系统

---

### 2️⃣ 单日亏损限制（Daily Loss Limit）

```
触发条件：单日亏损 ≤ -5%
触发后果：⚠️  暂停当天交易，明天自动恢复

示例：
今日起始: $10,000
当前权益: $9,500 或更低
→ 今日暂停交易，明天 00:00 自动重置
```

**优势**：
- 防止连续亏损
- 给系统和市场"冷静期"
- 自动恢复，无需手动干预

---

### 3️⃣ 三合一智能止盈系统

#### 第1层：分批止盈

| 浮盈阈值 | 平仓比例 | 说明 |
|---------|---------|------|
| +50% | 30% | 记录触发点（nof1.ai限制） |
| +100% | 50% | 记录触发点 |
| +200% | 100% | 立即全平仓 |

#### 第2层：高点回撤保护

```
条件：浮盈 > +30% 且从最高点回撤 ≥ 15%
动作：立即全平仓

示例：
BTC 开仓价: $65,000
最高浮盈: $150,000 (+131%)
当前价格: $130,000 (+100%)
回撤幅度: 15.4% > 15%
→ 🛡️ 回撤保护触发，锁定 +100% 利润
```

#### 第3层：移动止损

| 浮盈阈值 | 止损价 | 保护效果 |
|---------|--------|---------|
| +30% | 成本价 | 保本 |
| +50% | 成本价 +20% | 锁定 20% 利润 |
| +100% | 成本价 +40% | 锁定 40% 利润 |

---

## 方案A执行步骤

### 阶段1：模拟测试（1-3天）

**目标**：验证系统逻辑正确性

#### 操作步骤：

1. **确认配置**（已完成）
```typescript
// lib/config.ts
USE_REAL_TRADING: true  // 使用测试网
USE_REAL_AI: true       // 使用真实AI
```

2. **启动系统**
```bash
npm run dev
```

3. **观察日志**
重点关注：
- ✅ 智能止盈触发日志 `[SmartProfit]`
- ✅ 安全检查日志 `[Safety]`
- ✅ AI决策合理性
- ❌ 是否有错误日志

4. **记录数据**
每天记录：
- 总回报率
- 触发的智能止盈次数
- 是否有bug或异常

---

### 阶段2：小资金实盘（1-2周）

**目标**：验证真实市场表现

#### 资金建议：

| 你的情况 | 建议金额 |
|---------|---------|
| 完全新手 | $100-$200 |
| 有经验 | $300-$500 |
| 风险承受能力强 | $500-$1000 |

**❗ 重要**：使用你能承受**全部损失**的金额！

#### 操作步骤：

1. **入金到 Hyperliquid**
   - 使用测试网（testnet）或主网
   - 配置 `.env.local` 中的 API Key

2. **修改初始资金配置**
```typescript
// lib/config.ts
SAFETY: {
  INITIAL_CAPITAL: 200, // 改成你的实际入金金额
}
```

3. **启动并监控**
```bash
npm run dev
```

4. **每日检查清单**（10分钟）
- [ ] 查看总回报率
- [ ] 检查安全状态（熔断/限制）
- [ ] 查看完成的交易记录
- [ ] 检查AI决策质量

---

### 阶段3：逐步增加（谨慎）

**前置条件**：
- ✅ 阶段2盈利 >20%
- ✅ 运行2周以上无重大bug
- ✅ 你对系统表现满意

**增资策略**：
```
第1周: $200
第2周: $400 (2x)
第4周: $800 (2x)
第6周: $1,600 (2x)
...
```

**⚠️ 切勿**：
- ❌ 一次性投入大额资金
- ❌ 亏损时加大投入
- ❌ 盲目相信历史表现

---

## 监控与调整

### 实时监控指标

访问 `http://localhost:3000` 查看：

1. **账户总览**
   - 总回报率
   - 当前持仓
   - 可用现金

2. **安全状态**
```typescript
// 在浏览器控制台执行：
fetch('/api/safety-status')
  .then(r => r.json())
  .then(console.log)
```

输出示例：
```json
{
  "tradingHalted": false,
  "dailyLossPaused": false,
  "totalReturn": 12.5,
  "dailyReturn": 2.3,
  "totalLossRemaining": 32.5,  // 距离熔断还有 32.5%
  "dailyLossRemaining": 7.3    // 距离暂停还有 7.3%
}
```

3. **交易记录**
   - 查看所有完成的交易
   - 分析盈亏分布
   - 评估AI决策质量

---

### 何时调整参数

#### 情况1：亏损过快

**表现**：单日亏损 >3%，连续3天

**调整**：
```typescript
// lib/tradingPromptNOF1.ts
// 降低AI的激进程度（在系统提示词中）

// lib/config.ts
SAFETY: {
  MAX_DAILY_LOSS_PERCENT: 3, // 从 5% 降到 3%
}
```

#### 情况2：错过盈利机会

**表现**：AI经常 `hold`，不开仓

**调整**：
```typescript
// lib/tradingPromptNOF1.ts
// 在系统提示词中鼓励更积极的交易
```

#### 情况3：智能止盈过早

**表现**：+30% 就被止盈，错过更大涨幅

**调整**：
```typescript
// lib/tradingEngine.ts
// applySmartProfitProtection() 方法中调整阈值
if (pnlPercent >= 70) { // 从 50% 改为 70%
  // ...
}
```

---

## 常见问题

### Q1：系统突然停止交易了？

**A**：检查以下可能性：
1. 触发了总亏损熔断（-20%）
   - 查看日志确认
   - 需要手动调整后重启
2. 触发了单日亏损限制（-5%）
   - 会自动在明天恢复
3. API Key 失效
   - 检查 `.env.local` 配置

---

### Q2：如何关闭智能止盈系统？

**A**：不建议关闭，但如果需要：

```typescript
// lib/tradingEngine.ts
case 'hold':
  if (existingPosition) {
    // 注释掉这行
    // this.applySmartProfitProtection(account, completedTrades, model.displayName);

    this.checkExitConditions(account, completedTrades, model.displayName, decision.coin);
  }
  break;
```

---

### Q3：能否实时修改配置？

**A**：需要重启系统才能生效：
1. 修改 `lib/config.ts`
2. 保存文件
3. 重启 `npm run dev`

---

### Q4：如何手动平掉所有仓位？

**A**：在浏览器控制台执行：
```javascript
fetch('/api/close-all-positions', { method: 'POST' })
  .then(r => r.json())
  .then(console.log)
```

---

### Q5：每天需要花多少时间管理？

**A**：
- **最少**：5分钟（查看总回报和安全状态）
- **推荐**：10-15分钟（检查交易记录和AI决策）
- **深度分析**：30分钟/周（评估策略效果）

---

## 📞 获取帮助

如果遇到问题：

1. **查看日志**
```bash
# 终端中会实时显示详细日志
npm run dev
```

2. **检查配置**
```bash
# 查看当前配置摘要
grep -A 20 "SAFETY:" lib/config.ts
```

3. **联系开发者**
   - GitHub Issues: [项目地址]
   - 描述问题时附上日志截图

---

## ✅ 方案A总结

| 阶段 | 时长 | 资金 | 目标 |
|------|------|------|------|
| 阶段1 | 1-3天 | $0 | 验证逻辑 |
| 阶段2 | 1-2周 | $100-$500 | 真实测试 |
| 阶段3 | 持续 | 逐步增加 | 盈利 |

**关键原则**：
- 🐌 慢慢来，别急
- 📊 数据说话，不靠感觉
- 🛡️ 安全第一，利润第二
- 🧠 持续学习，优化策略

---

**祝你交易顺利！记住：加密货币交易有风险，投资需谨慎。** 🚀
