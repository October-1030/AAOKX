# 🔬 回测系统使用指南

回测系统借鉴了 **Nautilus Trader** 的回测理念，可以用历史数据测试AI策略，避免真金白银试错。

---

## 🎯 **什么是回测？**

**回测（Backtesting）** = 用历史数据模拟交易，测试策略是否有效

### **优势**：
- ✅ 不用真钱，安全测试
- ✅ 快速验证策略（几分钟跑完几天的交易）
- ✅ 发现策略缺陷
- ✅ 优化参数

### **局限**：
- ⚠️ 历史数据不代表未来
- ⚠️ 滑点和成交问题在回测中简化了
- ⚠️ 过度拟合风险（策略太适应历史数据）

---

## 🚀 **快速开始**

### **1. 运行回测**

```bash
npm run backtest
```

### **2. 查看结果**

回测完成后会显示：
```
📊 回测结果: DeepSeek V3.1
============================================================
💰 总回报: +12.5% (+$125.00)
💵 最终权益: $1,125.00
📈 总交易: 15 (9 盈利, 6 亏损)
🎯 胜率: 60.0%
📊 夏普比率: 1.25
📊 索提诺比率: 1.80
📉 最大回撤: 8.5% ($85.00)
💹 盈利因子: 2.15
💚 平均盈利: $25.50
💔 平均亏损: $12.30
⏱️  执行时间: 45.20s
============================================================
```

---

## 📊 **指标解释**

### **总回报（Total Return）**
- **含义**：从初始资金到最终权益的百分比变化
- **计算**：`(最终权益 - 初始资金) / 初始资金 × 100%`
- **示例**：$1,000 → $1,125 = +12.5%
- **目标**：越高越好

---

### **胜率（Win Rate）**
- **含义**：盈利交易占总交易的百分比
- **计算**：`盈利交易数 / 总交易数 × 100%`
- **示例**：15笔交易，9笔盈利 = 60%
- **注意**：胜率高不代表赚钱多！可能是"赚小钱亏大钱"

---

### **夏普比率（Sharpe Ratio）**
- **含义**：风险调整后的收益，衡量每承担1单位风险获得的回报
- **计算**：`(平均回报 - 无风险利率) / 回报标准差`
- **评价标准**：
  - `< 1.0` - 一般
  - `1.0 - 2.0` - 良好 ✅
  - `> 2.0` - 优秀 🌟
- **示例**：夏普比率 1.25 = 良好

---

### **索提诺比率（Sortino Ratio）**
- **含义**：类似夏普比率，但只考虑下行风险（亏损的波动）
- **优势**：比夏普比率更准确，因为盈利的波动不算风险
- **评价**：通常比夏普比率高
- **示例**：索提诺 1.80，夏普 1.25 → 说明亏损控制得好

---

### **最大回撤（Max Drawdown）**
- **含义**：从最高点到最低点的最大跌幅
- **计算**：`(最高权益 - 最低权益) / 最高权益 × 100%`
- **示例**：权益从 $1,200 跌到 $1,100 = 8.3% 回撤
- **目标**：越小越好，<10% 理想

---

### **盈利因子（Profit Factor）**
- **含义**：总盈利 / 总亏损
- **计算**：`所有盈利交易之和 / 所有亏损交易之和`
- **评价标准**：
  - `< 1.0` - 亏钱 ❌
  - `1.0 - 1.5` - 勉强 ⚠️
  - `1.5 - 2.0` - 良好 ✅
  - `> 2.0` - 优秀 🌟
- **示例**：盈利因子 2.15 → 赚的钱是亏的钱的2.15倍

---

## 🔧 **自定义回测参数**

编辑 `run-backtest.ts` 文件：

```typescript
// 回测的币种
const COINS: Coin[] = ['BTC', 'ETH', 'SOL', 'BNB'];  // 添加更多币种

// K线间隔
const INTERVAL = '1h';    // 可选: '1m', '5m', '15m', '1h', '4h', '1d'

// 回测天数
const DAYS = 30;          // 改成30天回测

// 初始资金
const INITIAL_CAPITAL = 5000;  // 改成$5,000

// 是否启用风险管理
enableRiskManagement: true,    // false = 禁用风险管理
```

---

## 📈 **实际示例**

### **示例 1：成功的策略**
```
回测时长: 7天
初始资金: $1,000
最终权益: $1,180
总回报: +18.0% ✅
胜率: 65%
最大回撤: 5.5%
夏普比率: 2.1
盈利因子: 2.8

✅ 评价: 优秀！高回报、低回撤、高盈利因子
```

---

### **示例 2：失败的策略**
```
回测时长: 7天
初始资金: $1,000
最终权益: $850
总回报: -15.0% ❌
胜率: 70%
最大回撤: 22.0%
夏普比率: -0.5
盈利因子: 0.75

❌ 评价: 失败！虽然胜率高，但平均亏损太大
问题: "赚小钱亏大钱" 策略
```

---

### **示例 3：风险过高的策略**
```
回测时长: 7天
初始资金: $1,000
最终权益: $1,250
总回报: +25.0% ⚠️
胜率: 50%
最大回撤: 35.0% ❌
夏普比率: 0.6
盈利因子: 1.8

⚠️ 评价: 回报高但风险太大
问题: 最大回撤35%，可能爆仓
```

---

## 🔍 **如何分析回测结果**

### **第1步：看总回报**
- 正数 → 策略赚钱 ✅
- 负数 → 策略亏钱 ❌

### **第2步：看最大回撤**
- < 10% → 风险可控 ✅
- 10% - 20% → 中等风险 ⚠️
- \> 20% → 高风险 ❌

### **第3步：看夏普比率**
- \> 1.5 → 风险调整后收益良好 ✅
- 0.5 - 1.5 → 一般 ⚠️
- < 0.5 → 不佳 ❌

### **第4步：看盈利因子**
- \> 2.0 → 赚得多亏得少 ✅
- 1.5 - 2.0 → 还不错 ⚠️
- < 1.5 → 需要改进 ❌

### **第5步：看交易明细**
- 检查是否有异常交易
- 分析亏损最大的交易原因
- 优化止损/止盈策略

---

## 🚨 **常见问题**

### **Q1: 回测很赚钱，为什么实盘亏损？**
**A:** 可能的原因：
1. **过度拟合** - 策略太适应历史数据
2. **滑点** - 实盘成交价可能不如预期
3. **市场环境变化** - 历史不代表未来
4. **手续费** - 回测可能低估了手续费

**建议**：
- 测试更长时间（至少30天）
- 测试不同市场环境（牛市/熊市）
- 加入更真实的滑点模拟

---

### **Q2: 如何提高策略表现？**
**A:** 尝试以下方法：
1. **调整止损/止盈** - 找到最优点
2. **优化仓位大小** - 使用Kelly公式
3. **增加过滤条件** - 只在高胜率时交易
4. **结合多个指标** - 避免虚假信号

---

### **Q3: 回测需要多少数据？**
**A:** 建议：
- **最少**: 7天（快速测试）
- **标准**: 30天（可靠）
- **理想**: 90天+ （充分验证）

---

### **Q4: 如何避免过度拟合？**
**A:** 方法：
1. **样本外测试** - 用新数据测试
2. **交叉验证** - 多个时间段测试
3. **参数简单化** - 避免过多规则
4. **保守估计** - 风险放大1.5倍

---

## 📁 **回测结果文件**

回测完成后，结果保存在：
```
backtest-results/
└── backtest_deepseek-v3-1_2025-01-24T10-30-00.json
```

文件内容包括：
- 所有性能指标
- 每笔交易详情
- 完整权益曲线
- 回测配置参数

可以用于：
- 对比不同策略
- 生成图表
- 深入分析

---

## 🎓 **借鉴自 Nautilus Trader**

本回测系统借鉴了 Nautilus Trader 的以下理念：
- ✅ 严格的历史数据回放
- ✅ 精确的订单执行模拟
- ✅ 完整的性能指标计算
- ✅ 支持多币种同时回测

---

## 🔗 **下一步**

1. **运行首次回测** → `npm run backtest`
2. **分析结果** → 查看哪里赚钱，哪里亏损
3. **优化策略** → 调整参数
4. **重新回测** → 验证改进效果
5. **实盘小资金测试** → 谨慎验证

---

**记住：回测只是第一步，实盘才是真正的考验！** 🎯
